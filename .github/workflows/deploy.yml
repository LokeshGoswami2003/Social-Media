name: Deploy Social Media App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout code
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Setup Node (CI machine)
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # -----------------------------
      # 3. Build Frontend (CI side)
      # -----------------------------
      - name: Install client dependencies
        working-directory: client
        run: npm install

      - name: Build React app
        working-directory: client
        run: npm run build

      # -----------------------------
      # 4. Prepare Backend (CI side)
      # -----------------------------
      - name: Install server dependencies
        working-directory: server
        run: npm install

      # -----------------------------
      # 5. Prepare EC2 directories & ownership
      # -----------------------------
      - name: Prepare EC2 directories and permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo mkdir -p /home/ubuntu/apps/Social-Media/build
            sudo mkdir -p /home/ubuntu/apps/Social-Media/server

            # CI must be able to write
            sudo chown -R ubuntu:ubuntu /home/ubuntu/apps/Social-Media

      # -----------------------------
      # 6. Upload Frontend Build
      # -----------------------------
      - name: Upload frontend build
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "client/build/**"
          target: "/home/ubuntu/apps/Social-Media/build"
          strip_components: 2

      # -----------------------------
      # 7. Upload Backend Code
      # -----------------------------
      - name: Upload backend code
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "server/*"
          target: "/home/ubuntu/apps/Social-Media/server"

      # -----------------------------
      # 8. Restart backend + fix runtime permissions
      # -----------------------------
      - name: Restart backend with PM2 and fix permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Load Node & PM2 for non-interactive shell
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            # Restart backend
            cd /home/ubuntu/apps/Social-Media/server
            pm2 restart social-api || pm2 start index.js --name social-api

            # Give Nginx read access (runtime user)
            sudo chown -R www-data:www-data /home/ubuntu/apps/Social-Media/build
            sudo chmod -R 755 /home/ubuntu/apps/Social-Media/build
